# JavaScript plusone: OIDC + JFrog CLI (npm + docker), build info with deps + image
# OIDC: set vars.JF_URL and vars.JF_OIDC_PROVIDER_NAME; setup-jfrog-cli provides oidc-user and oidc-token for Docker
# Fallback (no OIDC): set secrets.JF_USER and secrets.JF_ACCESS_TOKEN

name: JavaScript

on:
  push:
    branches: [main]
    paths: ['Javascript/**', '.github/workflows/javascript.yml']
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  JF_URL: ${{ vars.JF_URL }}
  JF_PROJECT: end2end-demo
  JFROG_CLI_AVOID_NEW_VERSION_WARNING: "true"
  JFROG_CLI_BUILD_NAME: plusone-javascript
  APP_NAME: plusone-javascript
  IMAGE_NAME: plusone-javascript
  ARTIFACTORY_REPO: tompazus.jfrog.io/docker-virtual

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set version (semver 1.0.N from run number)
        run: |
          echo "VERSION=1.0.$((${{ github.run_number }} - 1))" >> $GITHUB_ENV
          echo "JFROG_CLI_BUILD_NUMBER=1.0.$((${{ github.run_number }} - 1))" >> $GITHUB_ENV
          echo "BUILD_INFO_REPO_KEY=${{ env.JF_PROJECT }}-build-info" >> $GITHUB_ENV

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up JFrog CLI (OIDC or token)
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@v4
        with:
          oidc-provider-name: tpaz1/end2end-demos@github
        env:
          JF_URL: ${{ vars.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_USER: ${{ secrets.JF_USER }}

      - name: Set auth for Docker (OIDC token or fallback to secrets)
        run: |
          if [ -n "$OIDC_USER" ]; then
            echo "ARTIFACTORY_USER=$OIDC_USER" >> $GITHUB_ENV
            echo "ARTIFACTORY_TOKEN=$OIDC_TOKEN" >> $GITHUB_ENV
          else
            echo "ARTIFACTORY_USER=$SECRET_USER" >> $GITHUB_ENV
            echo "ARTIFACTORY_TOKEN=$SECRET_TOKEN" >> $GITHUB_ENV
          fi
        env:
          OIDC_USER: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          OIDC_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}
          SECRET_USER: ${{ secrets.JF_USER }}
          SECRET_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Configure npm for Artifactory
        run: |
          cd Javascript
          jf npm-config --repo-resolve=npm-virtual

      - name: Capture npm dependencies (for build info)
        run: |
          cd Javascript
          jf npm install --build-name=${{ env.JFROG_CLI_BUILD_NAME }} --build-number=${{ env.JFROG_CLI_BUILD_NUMBER }} --project end2end-demo
        env:
          JF_NPM_REPO_RESOLVE: npm-virtual

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker login (Artifactory)
        run: |
          echo "${{ env.ARTIFACTORY_TOKEN }}" | docker login ${{ vars.ARTIFACTORY_DOMAIN || 'tompazus.jfrog.io' }} -u "${{ env.ARTIFACTORY_USER }}" --password-stdin

      - name: Build image (load locally for scan)
        run: |
          IMAGE="${{ env.ARTIFACTORY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          docker buildx build \
            --platform linux/amd64 \
            --load \
            --build-arg ARTIFACTORY_USER=${{ env.ARTIFACTORY_USER }} \
            --build-arg ARTIFACTORY_TOKEN=${{ env.ARTIFACTORY_TOKEN }} \
            -t "$IMAGE" \
            ./Javascript

      - name: Docker image scan (Xray)
        run: |
          IMAGE="${{ env.ARTIFACTORY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          jf docker scan "$IMAGE" --project end2end-demo

      - name: Build and push multi-platform image (amd64 + arm64)
        run: |
          IMAGE="${{ env.ARTIFACTORY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            --build-arg ARTIFACTORY_USER=${{ env.ARTIFACTORY_USER }} \
            --build-arg ARTIFACTORY_TOKEN=${{ env.ARTIFACTORY_TOKEN }} \
            -t "$IMAGE" \
            ./Javascript

      - name: Add image to build info
        run: |
          IMAGE="${{ env.ARTIFACTORY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          DIGEST=$(docker buildx imagetools inspect "$IMAGE" 2>&1 | grep -oE 'sha256:[a-f0-9]+' | head -1)
          echo "$IMAGE@$DIGEST" > /tmp/docker-image.txt
          jf rt build-docker-create --image-file=/tmp/docker-image.txt docker-virtual \
            --build-name=${{ env.JFROG_CLI_BUILD_NAME }} \
            --build-number=${{ env.JFROG_CLI_BUILD_NUMBER }} \
            --project end2end-demo

      - name: Publish build info (git, env, publish)
        run: |
          jf rt build-collect-env --project end2end-demo
          jf rt build-add-git --project end2end-demo
          jf rt build-publish --project end2end-demo
        env:
          JFROG_CLI_BUILD_NAME: ${{ env.JFROG_CLI_BUILD_NAME }}
          JFROG_CLI_BUILD_NUMBER: ${{ env.JFROG_CLI_BUILD_NUMBER }}

      - name: Build scan (Xray)
        run: |
          jf build-scan ${{ env.JFROG_CLI_BUILD_NAME }} ${{ env.JFROG_CLI_BUILD_NUMBER }} --project end2end-demo

      - name: Create bundle spec
        env:
          BUILD_NAME: ${{ env.JFROG_CLI_BUILD_NAME }}
          BUILD_VERSION: ${{ env.VERSION }}
          BUILD_INFO_REPO_KEY: ${{ env.BUILD_INFO_REPO_KEY }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          cat > bundle-spec.json <<EOF
          {
            "builds": [
              {
                "name": "${BUILD_NAME}",
                "number": "${BUILD_VERSION}",
                "repository_key": "${BUILD_INFO_REPO_KEY}",
                "include_dependencies": true
              }
            ]
          }
          EOF
          jf apptrust version-create "${APP_NAME}" "${BUILD_VERSION}" --spec=bundle-spec.json --tag="${APP_NAME}"

      - name: Trigger promotion workflow
        run: |
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/promotion.yml/dispatches" \
            -d '{"ref":"${{ github.ref_name }}","inputs":{"app_name":"${{ env.APP_NAME }}","version":"${{ env.VERSION }}","target_stage":"DEV"}}'
